\documentclass{article}

\usepackage[english]{babel}
\usepackage{gensymb}
\usepackage[letterpaper,top=1.5cm,bottom=1.5cm,left=2cm,right=3cm,marginparwidth=1.5cm]{geometry}
\usepackage{listings}

% Useful packages
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}

\title{Report Advanced Programming for HPC}
\author{Ha Ngoc Linh - M21.ICT006}

\begin{document}
\maketitle

\section{Formula}
\subsection{RGB to HSV}
\begin{equation}
H = \begin{cases}
0 \degree &\text{ $\Delta\ =  0$}\\
60 \degree \times \frac{G - B}{\Delta}mod 6 &\text{ $max\ =  R$}\\
60 \degree \times \frac{B - R}{\Delta} + 2 &\text{ $max\ =  G$}\\
60 \degree \times \frac{R - G}{\Delta} + 4 &\text{ $max\ =  B$}\\
\end{cases}
\end{equation}

\begin{equation}
S = \begin{cases}
0  &\text{ $\max =  0$}\\
\frac{\Delta}{max} &\text{ $max\ \neq  0$}\\
\end{cases}
\end{equation}

\begin{equation}
V = max
\end{equation}

\subsection{Kuwahara filter}

\begin{enumerate}

\item Get V value in HSV space of the image.
\item Define window size (region size) ({\omega}).

\item In each region:

    \begin{itemize}
    
        \item Calculate the summary value of all pixels in the region to get the mean value 
        \begin{equation}
            mean = \frac{\sum r(x,y)}{\omega \times \omega}
        \end{equation}
        \item Calculate the standard deviation of the region i
        \begin{equation}
            std_i = \sqrt{\frac{\sum ((V(x,y) - mean)^2)}{\omega \times \omega}}
        \end{equation}
    
    \end{itemize}

\item Find the minimum value in 4 standard deviation values (4 regions)

\item Assign mean(R,G,B) value of this region as new color
    \begin{equation}
        R = avg_R = \frac{\sum(R(x,y)}{\omega \times \omega}
    \end{equation}
    \begin{equation}
        B = avg_B = \frac{\sum(B(x,y)}{\omega \times \omega}
    \end{equation}
    \begin{equation}
        G = avg_G = \frac{\sum(G(x,y)}{\omega \times \omega}
    \end{equation}

\end{itemize}

\end{enumerate}

\section{Kuwahara filter in CPU}

\subsection{Transfer RGB to HSV in CPU}

To transfer RGB to HSV, I follow the formula (1), (2), (3) on each pixel of the image:
\begin{lstlisting}[language=Python]
    height, width = src.shape[0], src.shape[1]
    for tidx in range(height):
       for tidy in range(width):
\end{lstlisting}
I calculate H, S, V values of each pixel by following this code:
\begin{lstlisting}[language=Python]
            b = src[tidx, tidy, 0] / 255
            g = src[tidx, tidy, 1] / 255
            r = src[tidx, tidy, 2] / 255
            cmax = max(r, g, b)
            cmin = min(r, g, b)
            delta = cmax - cmin
            if delta == 0:
                h = 0
            elif cmax == r:
                h = ((((g - b) / delta) % 6) * 60)  % 360
            elif cmax == g:
                h = ((((b - r) / delta) + 2) * 60) % 360
            elif cmax == b:
                h = ((((r - g) / delta) + 4) * 60) % 360
            if cmax == 0:
                s = 0
            else:
                s = delta / cmax
            v = cmax

            dst[tidx, tidy, 0] = h % 360
            dst[tidx, tidy, 1] = s * 100
            dst[tidx, tidy, 2] = v * 100
\end{lstlisting}

\subsection{Kuwahara filter function in CPU}
Following each step defined in section 1.2
\begin{itemize}
    \item To get V value
    
    \begin{lstlisting}[language=Python]
    v = hsv[:, :, 2]
    \end{lstlisting}

    \item \text{window\_size} will be passed into the Kuwahara filter function with integer type value

    \item On each region, the standard deviation value will be calculated by following code

    \begin{lstlisting}[language=Python]
            # first region  rx1 belongs to [tidx - window_size, tidx] and ry1 belongs to [tidy - window_size, tidy]
            sum1 = np.float32(0)
            for rx1 in range(tidx - window_size, tidx): 
                for ry1 in range(tidy - window_size, tidy): 
                    if rx1 >= 0 and ry1 >= 0 and rx1 < height and ry1 < width:
                        sum1 += v[rx1, ry1]
            # find standard deviation of first region
            mean1 = sum1 / ((window_size) * (window_size))
            sum1 = np.float32(0)
            for rx1 in range(tidx - window_size, tidx): 
                for ry1 in range(tidy - window_size, tidy): 
                    if rx1 >= 0 and ry1 >= 0 and rx1 < height and ry1 < width:
                        sum1 += (v[rx1, ry1] - mean1) ** 2
            std1 = math.sqrt(sum1 / ((window_size) * (window_size)))
    \end{lstlisting}

    The calculation is the same for 3 regions left by looping all the pixels of the image
    
    \begin{lstlisting}[language=Python]
    height, width = src.shape[0], src.shape[1]
    for tidx in range(height):
        for tidy in range(width):
    \end{lstlisting}

    \item finding the minimum standard deviation value
    
    \begin{lstlisting}[language=Python]
    min_std = min(std1, std2, std3, std4)
    \end{lstlisting}

    \item Calculate the mean of RGB space color of the region as new color

    \begin{lstlisting}[language=Python]
            # assign the mean of the region with minimum standard deviation to the pixel
            avg_r = np.float32(0)
            avg_g = np.float32(0)
            avg_b = np.float32(0)

            if min_std == std1:
                for rx1 in range(tidx - window_size, tidx): 
                    for ry1 in range(tidy - window_size, tidy): 
                        if rx1 >= 0 and ry1 >= 0 and rx1 < height and ry1 < width:
                            avg_r += src[rx1, ry1, 2]
                            avg_g += src[rx1, ry1, 1]
                            avg_b += src[rx1, ry1, 0]
            if min_std == std2:
                for rx2 in range(tidx, tidx + window_size): 
                    for ry2 in range(tidy - window_size, tidy): 
                        if rx2 >= 0 and ry2 >= 0 and rx2 < height and ry2 < width:
                            avg_r += src[rx2, ry2, 2]
                            avg_g += src[rx2, ry2, 1]
                            avg_b += src[rx2, ry2, 0]

            if min_std == std3:
                for rx3 in range(tidx - window_size, tidx): 
                    for ry3 in range(tidy, tidy + window_size): 
                        if rx3 >= 0 and ry3 >= 0 and rx3 < height and ry3 < width:
                            avg_r += src[rx3, ry3, 2]
                            avg_g += src[rx3, ry3, 1]
                            avg_b += src[rx3, ry3, 0]

            if min_std == std4:
                for rx4 in range(tidx, tidx + window_size): 
                    for ry4 in range(tidy, tidy + window_size): 
                        if rx4 >= 0 and ry4 >= 0 and rx4 < height and ry4 < width:
                            avg_r += src[rx4, ry4, 2]
                            avg_g += src[rx4, ry4, 1]
                            avg_b += src[rx4, ry4, 0]

            avg_r = avg_r / (window_size * window_size)
            avg_g = avg_g / (window_size * window_size)
            avg_b = avg_b / (window_size * window_size)

            dst[tidx, tidy, 2] = avg_r
            dst[tidx, tidy, 1] = avg_g
            dst[tidx, tidy, 0] = avg_b
    \end{lstlisting}
    
\end{itemize}

\end{document}